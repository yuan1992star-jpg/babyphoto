<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宝贝成长时光机</title>
    <!-- 优先使用本地资源，支持完全离线运行 -->
    <script src="/assets/js/tailwind.js"></script>
    
    <link href="/assets/fonts/noto_sans_sc_kuai_le.css" rel="stylesheet">
    
    <script src="/assets/js/vue.global.js"></script>
    
    <script src="/assets/js/lucide.min.js"></script>
    
    <style>
        :root {
            --primary-pink: #ffafbd;
            --primary-blue: #c9ffbf;
            --soft-bg: #fdfbfb;
        }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            min-height: 100vh;
        }
        .baby-title {
            font-family: 'ZCOOL KuaiLe', cursive;
        }
        .timeline-dot::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 12px;
            width: 18px;
            height: 18px;
            background: white;
            border: 4px solid #f472b6;
            border-radius: 50%;
            z-index: 10;
        }
        .timeline-line {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #fbcfe8;
            margin-left: -1px;
        }
        .photo-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            contain: layout paint;
        }
        .photo-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="text-slate-700">
    <div id="app" v-cloak class="flex flex-col md:flex-row min-h-screen">
        
        <!-- Global Drag Overlay -->
        <div v-if="isGlobalDragging" class="fixed inset-0 z-[100] bg-pink-400/80 backdrop-blur-md flex flex-col items-center justify-center text-white p-8 pointer-events-none transition-all">
            <div class="border-4 border-dashed border-white/50 rounded-3xl w-full h-full flex flex-col items-center justify-center animate-pulse">
                <i data-lucide="sparkles" class="w-24 h-24 mb-6"></i>
                <h2 class="text-4xl baby-title">把回忆交给我吧...</h2>
                <p class="text-xl mt-4 opacity-80">支持批量拖入照片和视频</p>
            </div>
        </div>

        <!-- Left Sidebar (Desktop) -->
        <aside class="w-full md:w-80 glass-morphism sticky top-0 md:h-screen z-20 flex flex-col p-6 shadow-xl border-r">
            <div class="flex items-center space-x-3 mb-10">
                <div class="bg-gradient-to-tr from-pink-400 to-rose-400 p-3 rounded-2xl shadow-lg shadow-pink-200">
                    <i data-lucide="baby" class="w-8 h-8 text-white"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold baby-title text-rose-500">成长时光机</h1>
                    <p class="text-xs text-slate-400 font-medium">RECORD EVERY MOMENT</p>
                </div>
            </div>

            <nav class="flex-1 space-y-2 overflow-y-auto pr-2 custom-scrollbar">
                <div class="flex flex-col space-y-1 mb-6">
                    <button @click="activeTab = 'gallery'" :class="activeTab === 'gallery' ? 'bg-pink-50 text-pink-600' : 'text-slate-600 hover:bg-slate-50'" class="flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold">
                        <i data-lucide="image" class="w-5 h-5"></i>
                        <span>美好相册</span>
                    </button>
                    <button @click="activeTab = 'pending'" :class="activeTab === 'pending' ? 'bg-pink-50 text-pink-600' : 'text-slate-600 hover:bg-slate-50'" class="flex items-center justify-between px-4 py-3 rounded-xl transition-all font-bold group">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="archive" class="w-5 h-5"></i>
                            <span>待归类</span>
                        </div>
                        <span v-if="pendingFiles?.length > 0" class="bg-rose-500 text-white text-[10px] px-2 py-0.5 rounded-full animate-pulse">
                            {{ pendingFiles?.length }}
                        </span>
                    </button>
                </div>

                <template v-if="activeTab === 'gallery'">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">时间航线</div>
                    <div v-for="group in groups" :key="group.date" class="relative pl-6 py-2 cursor-pointer group" @click="scrollToGroup(group.date)">
                        <div class="absolute left-1 top-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-pink-300 group-hover:scale-150 transition-transform"></div>
                        <div class="text-sm font-medium text-slate-600 group-hover:text-pink-500 transition-colors">{{ formatDisplayDate(group.date) }}</div>
                        <div class="text-[10px] text-slate-400">{{ group.count }} 枚回忆</div>
                    </div>
                </template>
            </nav>

            <button @click="showUpload = !showUpload" class="mt-8 w-full bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-pink-200 hover:shadow-pink-300 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center space-x-2">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                <span>导入新回忆</span>
            </button>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-10 relative">
            <!-- Mobile Header Decor -->
            <div class="md:hidden flex justify-between items-center mb-8">
                <h1 class="text-2xl baby-title text-rose-500">成长时光机</h1>
                <div class="flex items-center space-x-2">
                    <button @click="activeTab = 'pending'" class="relative bg-white p-3 rounded-full shadow-lg text-slate-400" :class="{'text-pink-500': activeTab === 'pending'}">
                        <i data-lucide="archive" class="w-6 h-6"></i>
                        <span v-if="pendingFiles?.length > 0" class="absolute -top-1 -right-1 bg-rose-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-white">
                            {{ pendingFiles?.length }}
                        </span>
                    </button>
                    <button @click="showUpload = !showUpload" class="bg-pink-500 text-white p-3 rounded-full shadow-lg">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <!-- Gallery Tab -->
            <div v-show="activeTab === 'gallery'">
                <!-- Upload Panel -->
                <transition name="fade">
                    <div v-show="showUpload" class="mb-10">
                        <div id="drop-zone" @dragover.prevent="onDragOver" @dragleave.prevent="onDragLeave" @drop.prevent="onDrop" 
                            class="relative glass-morphism rounded-3xl p-10 text-center border-2 border-dashed border-pink-200 hover:border-pink-400 transition-all cursor-pointer group"
                            :class="{'bg-pink-50 border-pink-400': isDragging}">
                            <input type="file" ref="fileInput" class="hidden" multiple @change="handleFileSelect" accept="image/*,video/*">
                            <div class="flex flex-col items-center" @click="$refs.fileInput.click()">
                                <div class="bg-pink-100 p-5 rounded-full text-pink-500 mb-6 group-hover:rotate-12 transition-transform">
                                    <i data-lucide="camera" class="w-12 h-12"></i>
                                </div>
                                <h3 class="text-xl font-bold text-slate-700 baby-title">点击或拖入照片/视频</h3>
                                <p class="text-slate-400 mt-2">我们会根据拍摄日期自动整理它们</p>
                            </div>

                            <!-- Upload Progress -->
                            <div v-if="uploadingFiles?.length > 0" class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div v-for="(file, index) in uploadingFiles" :key="index" class="bg-white/50 p-4 rounded-2xl border border-pink-50 flex items-center space-x-4">
                                    <div class="w-12 h-12 rounded-lg bg-slate-100 flex-shrink-0 flex items-center justify-center text-slate-400">
                                        <i data-lucide="file-text" class="w-6 h-6"></i>
                                    </div>
                                    <div class="flex-1 min-w-0 text-left">
                                        <div class="flex justify-between text-xs mb-1">
                                            <span class="truncate font-medium">{{ file.name }}</span>
                                            <span :class="file.status === 'success' || file.status === 'need_confirm' ? 'text-green-500' : 'text-pink-500'">
                                                {{ file.status === 'need_confirm' ? '待归类' : file.progress + '%' }}
                                            </span>
                                        </div>
                                        <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-pink-400 to-rose-400 transition-all duration-300" :style="{width: file.progress + '%'}"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>

                <!-- Gallery Content -->
                <div v-if="loading" class="flex flex-col items-center justify-center py-40">
                    <div class="w-16 h-16 border-4 border-pink-200 border-t-pink-500 rounded-full animate-spin"></div>
                    <p class="mt-4 text-slate-400 baby-title text-xl">时光机启动中...</p>
                </div>

                <div v-else-if="(groups?.length ?? 0) === 0" class="flex flex-col items-center justify-center py-32 bg-white/40 rounded-[3rem] border border-white">
                    <div class="relative mb-8">
                        <div class="absolute -inset-4 bg-pink-100 rounded-full animate-ping opacity-25"></div>
                        <div class="relative bg-white p-8 rounded-full shadow-xl text-pink-300">
                            <i data-lucide="camera-off" class="w-20 h-20"></i>
                        </div>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-600 baby-title">这里空空如也</h3>
                    <p class="text-slate-400 mt-2">点击左侧“导入新回忆”开启宝宝的时光旅程</p>
                </div>

                <div v-else class="space-y-16 pl-4 md:pl-10 relative">
                    <div class="timeline-line hidden md:block"></div>
                    
                    <div v-for="group in visibleGroups" :key="group.date" :id="'group-'+group.date" :data-date="group.date" class="relative timeline-dot">
                        <div class="mb-8">
                            <h2 class="text-3xl font-bold text-slate-800 baby-title inline-block relative pb-2 pl-1">
                                <span class="relative z-10">{{ formatDisplayDate(group.date) }}</span>
                                <span class="absolute bottom-1 left-0 w-full h-2 bg-pink-200 -z-10 rounded-full opacity-60"></span>
                            </h2>
                            <div class="ml-4 mt-2 flex items-center gap-4 flex-wrap">
                                <span class="text-sm font-bold text-slate-400">{{ group.count }} 枚瞬间</span>
                                <span v-if="birthDate" class="text-sm font-bold text-pink-500 bg-pink-50 px-3 py-1 rounded-full">
                                    宝宝 {{ getBabyAge(group.date) }}
                                </span>
                            </div>
                        </div>

                        <div class="grid grid-cols-5 gap-3">
                            <!-- 照片渲染 -->
                            <template v-if="group.photos">
                                <div v-for="photo in (group.expanded ? group.photos : group.photos.slice(0, 5))" :key="photo.url" @click="openLightbox(photo)" 
                                    class="photo-card aspect-square rounded-2xl overflow-hidden bg-white shadow-sm border-2 border-white cursor-pointer group relative">
                                    
                                    <img v-if="photo.type === 'image'" :src="photo.url" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" loading="lazy" decoding="async">
                                    <div v-else class="w-full h-full relative">
                                        <video :src="photo.url" class="w-full h-full object-cover" preload="metadata" muted playsinline></video>
                                        <div class="absolute inset-0 flex items-center justify-center bg-black/10 group-hover:bg-black/30 transition-colors">
                                            <div class="bg-white/90 p-3 rounded-full shadow-lg group-hover:scale-110 transition-transform">
                                                <i data-lucide="play" class="w-6 h-6 text-rose-500 fill-current"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    <div class="absolute bottom-2 left-2 right-2 flex justify-between items-center translate-y-6 group-hover:translate-y-0 transition-all duration-300">
                                        <span class="text-[8px] bg-white/20 backdrop-blur-md text-white px-1.5 py-0.5 rounded-md border border-white/30 font-bold">
                                            {{ photo.type === 'image' ? 'PHOTO' : 'VIDEO' }}
                                        </span>
                                        <div class="bg-white p-1.5 rounded-lg text-rose-500 shadow-lg">
                                            <i data-lucide="maximize-2" class="w-3 h-3"></i>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <!-- 加载中占位符 (Skeleton) -->
                            <template v-else>
                                <div v-for="i in Math.min(group.count, 5)" :key="i" class="aspect-square rounded-2xl bg-white/50 border-2 border-white/30 animate-pulse flex items-center justify-center">
                                    <i data-lucide="image" class="w-6 h-6 text-pink-200"></i>
                                </div>
                            </template>
                        </div>
                        
                        <div v-if="group.count > 5" class="mt-6 flex justify-center">
                             <button @click="toggleExpand(group)" class="px-6 py-2 bg-white border-2 border-pink-200 rounded-full text-pink-500 font-bold hover:bg-pink-50 hover:border-pink-300 transition-all flex items-center space-x-2 shadow-sm">
                                <span v-if="!group.expanded">查看剩余 {{ group.count - 5 }} 枚回忆</span>
                                <span v-else>收起</span>
                                <i :data-lucide="group.expanded ? 'chevron-up' : 'chevron-down'" class="w-4 h-4"></i>
                             </button>
                        </div>
                    </div>

                    <!-- 加载更多指示器 -->
                    <div v-if="visibleCount < (groups?.length ?? 0)" class="mt-8 flex justify-center">
                        <button 
                            @click="loadMore" 
                            :disabled="isLoadingMore"
                            class="px-6 py-3 bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold rounded-full shadow-lg shadow-pink-200 hover:shadow-pink-300 hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2">
                            <span v-if="!isLoadingMore">加载更多回忆 ({{ (groups?.length ?? 0) - visibleCount }} 个日期)</span>
                            <span v-else class="flex items-center space-x-2">
                                <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                <span>加载中...</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pending Inbox Tab -->
            <div v-show="activeTab === 'pending'" class="max-w-5xl mx-auto">
                <div class="flex items-center justify-between mb-10">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800 baby-title">待归类回忆</h2>
                        <p class="text-slate-400 mt-1">请为这些回忆指定一个日期，让它们回到时光机中</p>
                    </div>
                    <div v-if="(pendingFiles?.length ?? 0) > 1" class="flex space-x-3">
                        <!-- 批量操作可以后续扩展 -->
                    </div>
                </div>

                <div v-if="(pendingFiles?.length ?? 0) === 0" class="flex flex-col items-center justify-center py-32 bg-white/40 rounded-[3rem] border border-white">
                    <div class="bg-white p-8 rounded-full shadow-xl text-green-300 mb-6">
                        <i data-lucide="check-circle" class="w-20 h-20"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-600 baby-title">整理得真棒！</h3>
                    <p class="text-slate-400 mt-2">目前没有待归类的文件了</p>
                    <button @click="activeTab = 'gallery'" class="mt-6 text-pink-500 font-bold flex items-center space-x-2 hover:underline">
                        <span>返回相册</span>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </div>

                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div v-for="file in pendingFiles" :key="file.hash" class="bg-white rounded-[2rem] overflow-hidden shadow-xl shadow-slate-200/50 border border-slate-100 flex flex-col group">
                        <!-- Preview -->
                        <div class="aspect-video relative overflow-hidden bg-slate-900" @click="openLightbox(file)">
                            <img v-if="file.type === 'image'" :src="file.url" class="w-full h-full object-contain">
                            <div v-else class="w-full h-full relative">
                                <video :src="file.url" class="w-full h-full object-contain" preload="metadata" muted playsinline></video>
                                <div class="absolute inset-0 flex items-center justify-center bg-black/20 group-hover:bg-black/40 transition-colors">
                                    <div class="bg-white/90 p-4 rounded-full shadow-lg scale-90 group-hover:scale-100 transition-transform">
                                        <i data-lucide="play" class="w-8 h-8 text-rose-500 fill-current"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Info & Actions -->
                        <div class="p-6 flex-1 flex flex-col">
                            <div class="mb-4">
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">拍摄日期</label>
                                <div class="relative">
                                    <input type="date" v-model="file.date" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-pink-300 focus:outline-none transition-all text-slate-700">
                                    <div v-if="!file.date" class="absolute inset-y-0 right-4 flex items-center pointer-events-none text-rose-400">
                                        <i data-lucide="alert-circle" class="w-5 h-5"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="flex space-x-2 mt-auto">
                                <button @click="confirmFile(file)" :disabled="!file.date || file.processing" 
                                    class="flex-1 bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-pink-100 hover:shadow-pink-200 hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 flex items-center justify-center space-x-2">
                                    <span v-if="file.processing" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                                    <span v-else>确认归档</span>
                                </button>
                                <button @click="cancelFile(file)" :disabled="file.processing"
                                    class="p-3 bg-slate-50 text-slate-400 hover:bg-rose-50 hover:text-rose-500 rounded-xl transition-all">
                                    <i data-lucide="trash-2" class="w-6 h-6"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Birth Date Input Modal -->
        <transition name="fade">
            <div v-if="showBirthDateModal" class="fixed inset-0 z-[2000] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4">
                <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 relative" @click.stop>
                    <div class="text-center mb-6">
                        <div class="bg-gradient-to-tr from-pink-400 to-rose-400 p-4 rounded-full w-20 h-20 mx-auto mb-4 flex items-center justify-center shadow-lg">
                            <i data-lucide="heart" class="w-10 h-10 text-white"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 baby-title mb-2">欢迎使用成长时光机</h2>
                        <p class="text-slate-500 text-sm">请设置宝宝的出生日期，我们将为您记录每一个珍贵瞬间</p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">出生日期</label>
                        <input 
                            type="date" 
                            v-model="birthDateInput" 
                            class="w-full px-4 py-3 border-2 border-pink-200 rounded-xl focus:border-pink-400 focus:outline-none transition-colors text-slate-700"
                            :max="todayDate"
                        >
                    </div>
                    <button 
                        @click="saveBirthDate" 
                        :disabled="!birthDateInput"
                        class="w-full bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-pink-200 hover:shadow-pink-300 hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                        开始记录成长
                    </button>
                </div>
            </div>
        </transition>

        <!-- Lightbox -->
        <transition name="zoom">
            <div v-if="lightbox.show" class="fixed inset-0 z-[1000] bg-slate-900/95 backdrop-blur-xl flex items-center justify-center p-4 md:p-10" @click="closeLightbox">
                <button class="absolute top-8 right-8 text-white/50 hover:text-white transition-colors" @click.stop="closeLightbox">
                    <i data-lucide="x-circle" class="w-10 h-10"></i>
                </button>
                <div class="max-w-6xl w-full h-full flex flex-col items-center justify-center" @click.stop>
                    <div class="relative w-full h-full flex items-center justify-center">
                        <img v-if="lightbox.photo.type === 'image'" :src="lightbox.photo.url" class="max-w-full max-h-full object-contain rounded-2xl shadow-2xl">
                        <video v-else :src="lightbox.photo.url" controls autoplay class="max-w-full max-h-full rounded-2xl shadow-2xl"></video>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, computed, nextTick, onMounted, onUnmounted } = Vue;

        createApp({
            setup() {
                const groups = ref([]);
                const activeTab = ref('gallery');
                const pendingFiles = ref([]);
                const loading = ref(true);
                const showUpload = ref(false);
                const isDragging = ref(false);
                const isGlobalDragging = ref(false);
                const uploadingFiles = ref([]);
                const lightbox = ref({ show: false, photo: null });
                const showBirthDateModal = ref(false);
                const birthDateInput = ref('');
                const birthDate = ref(null);
                const todayDate = new Date().toISOString().split('T')[0];
                const visibleCount = ref(10); // 初始显示10个日期分组
                const isLoadingMore = ref(false);
                let dragCounter = 0;
                let observer = null;

                const initObserver = () => {
                    if (observer) observer.disconnect();
                    observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const date = entry.target.dataset.date;
                                const group = groups.value.find(g => g.date === date);
                                if (group && !group.photos && !group.loadingPhotos) {
                                    ensureGroupPhotosLoaded(group);
                                }
                            }
                        });
                    }, { rootMargin: '200px' }); // 提前 200px 开始加载

                    nextTick(() => {
                        document.querySelectorAll('.timeline-dot').forEach(el => {
                            observer.observe(el);
                        });
                    });
                };

                const fetchPending = async () => {
                    try {
                        const res = await fetch('/api/upload/pending');
                        const data = await res.json();
                        pendingFiles.value = data.map(f => ({ ...f, processing: false }));
                        setTimeout(() => lucide.createIcons(), 50);
                    } catch (e) {
                        console.error('获取待归类列表失败', e);
                    }
                };

                const confirmFile = async (file) => {
                    if (!file.date) return;
                    file.processing = true;
                    try {
                        const res = await fetch('/api/upload/confirm', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ hash: file.hash, ext: file.ext, date: file.date })
                        });
                        if (res.ok) {
                            pendingFiles.value = pendingFiles.value.filter(f => f.hash !== file.hash);
                            await fetchPhotosIndex();
                        } else {
                            const err = await res.json();
                            alert(err.error || '归档失败');
                        }
                    } catch (e) {
                        console.error('归档失败', e);
                    } finally {
                        file.processing = false;
                    }
                };

                const cancelFile = async (file) => {
                    if (!confirm('确定要取消上传并删除此文件吗？')) return;
                    file.processing = true;
                    try {
                        const res = await fetch('/api/upload/cancel', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ hash: file.hash, ext: file.ext })
                        });
                        if (res.ok) {
                            pendingFiles.value = pendingFiles.value.filter(f => f.hash !== file.hash);
                        }
                    } catch (e) {
                        console.error('取消失败', e);
                    } finally {
                        file.processing = false;
                    }
                };

                const fetchPhotosIndex = async () => {
                    loading.value = true;
                    try {
                        const res = await fetch('/api/photos');
                        const data = await res.json();
                        groups.value = data.map(g => ({ ...g, expanded: false, photos: null, loadingPhotos: false }));
                        visibleCount.value = 10;
                        
                        // 自动加载首屏前 5 个分组的照片
                        for (let i = 0; i < Math.min(groups.value.length, 5); i++) {
                            ensureGroupPhotosLoaded(groups.value[i]);
                        }

                        initObserver();
                        setTimeout(() => lucide.createIcons(), 50);
                    } catch (e) {
                        console.error("加载失败", e);
                    } finally {
                        loading.value = false;
                    }
                };

                const ensureGroupPhotosLoaded = async (group) => {
                    if (!group || group.photos) {
                        return;
                    }
                    if (group.loadingPhotos) {
                        return;
                    }
                    group.loadingPhotos = true;
                    try {
                        const res = await fetch('/api/photos/detail?date=' + encodeURIComponent(group.date));
                        const data = await res.json();
                        group.photos = Array.isArray(data) ? data : [];
                        setTimeout(() => lucide.createIcons(), 50);
                    } catch (e) {
                        console.error('加载详情失败', e);
                        group.photos = [];
                    } finally {
                        group.loadingPhotos = false;
                    }
                };

                // 计算可见的分组
                const visibleGroups = Vue.computed(() => {
                    return groups.value.slice(0, visibleCount.value);
                });

                const ensureGroupVisibleAndScroll = async (date) => {
                    const targetIndex = groups.value.findIndex(g => g.date === date);
                    if (targetIndex === -1) {
                        return;
                    }

                    // 如果目标分组不在已渲染范围内，先扩大可见范围
                    if (targetIndex >= visibleCount.value) {
                        visibleCount.value = Math.min(targetIndex + 1, groups.value.length);
                        await nextTick();
                        await new Promise(r => setTimeout(r, 30));
                    }

                    const group = groups.value[targetIndex];
                    await ensureGroupPhotosLoaded(group);

                    const el = document.getElementById('group-' + date);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };

                // 加载更多分组
                const loadMore = () => {
                    if (isLoadingMore.value || visibleCount.value >= groups.value.length) {
                        return;
                    }
                    isLoadingMore.value = true;
                    setTimeout(() => {
                        visibleCount.value = Math.min(visibleCount.value + 10, groups.value.length);
                        isLoadingMore.value = false;
                        initObserver();
                        setTimeout(() => lucide.createIcons(), 50);
                    }, 200);
                };

                // 滚动监听
                const handleScroll = () => {
                    if (isLoadingMore.value || visibleCount.value >= groups.value.length) {
                        return;
                    }
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const windowHeight = window.innerHeight;
                    const documentHeight = document.documentElement.scrollHeight;
                    // 当滚动到距离底部200px时加载更多
                    if (scrollTop + windowHeight >= documentHeight - 200) {
                        loadMore();
                    }
                };

                const formatDisplayDate = (dateStr) => {
                    const [y, m, d] = dateStr.split('-');
                    return `${y}年${parseInt(m)}月${parseInt(d)}日`;
                };

                // 计算宝宝年龄
                const getBabyAge = (photoDateStr) => {
                    if (!birthDate.value) return '';
                    
                    const [photoY, photoM, photoD] = photoDateStr.split('-').map(Number);
                    const photoDate = new Date(photoY, photoM - 1, photoD);
                    const birth = new Date(birthDate.value);
                    
                    // 计算总天数
                    const diffTime = photoDate - birth;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays < 0) return '还未出生';
                    if (diffDays === 0) return '出生当天';
                    
                    // 计算年、月、日
                    let years = photoY - birth.getFullYear();
                    let months = photoM - (birth.getMonth() + 1);
                    let days = photoD - birth.getDate();
                    
                    // 调整月份和天数
                    if (days < 0) {
                        months--;
                        const prevMonth = new Date(photoY, photoM - 1, 0);
                        days += prevMonth.getDate();
                    }
                    if (months < 0) {
                        years--;
                        months += 12;
                    }
                    
                    const parts = [];
                    // 总是显示天数（约多少天）
                    parts.push(`约${diffDays}天`);
                    
                    // 如果有月数，显示月数
                    if (months > 0) {
                        parts.push(`${months}个月`);
                    }
                    
                    // 如果有年数，显示岁数
                    if (years > 0) {
                        parts.push(`${years}岁`);
                    }
                    
                    // 如果小于1个月，只显示天数
                    if (diffDays < 30) {
                        return `约${diffDays}天`;
                    }
                    
                    // 按 岁、月、天的顺序显示
                    const resultParts = [];
                    if (years > 0) resultParts.push(`${years}岁`);
                    if (months > 0) resultParts.push(`${months}个月`);
                    resultParts.push(`约${diffDays}天`);
                    
                    return resultParts.join(' ');
                };

                // 保存出生日期
                const saveBirthDate = async () => {
                    if (!birthDateInput.value) return;
                    
                    try {
                        const res = await fetch('/api/birthdate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                birthDate: birthDateInput.value
                            })
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            birthDate.value = data.birthDate;
                            showBirthDateModal.value = false;
                        } else {
                            const error = await res.json();
                            alert('保存失败: ' + (error.error || '未知错误'));
                        }
                    } catch (e) {
                        console.error('保存出生日期失败', e);
                        alert('保存失败，请重试');
                    }
                };

                // 加载出生日期
                const loadBirthDate = async () => {
                    try {
                        const res = await fetch('/api/birthdate');
                        if (res.ok) {
                            const data = await res.json();
                            if (data.birthDate) {
                                birthDate.value = data.birthDate;
                                showBirthDateModal.value = false;
                            } else {
                                showBirthDateModal.value = true;
                            }
                        } else {
                            // 如果接口出错，显示输入框
                            showBirthDateModal.value = true;
                        }
                    } catch (e) {
                        console.error('加载出生日期失败', e);
                        // 出错时显示输入框
                        showBirthDateModal.value = true;
                    }
                };

                const handleFiles = async (files) => {
                    isGlobalDragging.value = false;
                    dragCounter = 0;
                    isDragging.value = false;
                    showUpload.value = true;
                    
                    const fileArray = Array.from(files);
                    const CHUNK_SIZE = 32 * 1024 * 1024; // 32MB
                    const CONCURRENT_LIMIT = 5; // 并发数 5
                    
                    for (const file of fileArray) {
                        const uploadItem = Vue.markRaw({ 
                            name: file.name, 
                            progress: 0, 
                            status: 'uploading' 
                        });
                        const reactiveItem = ref(uploadItem);
                        uploadingFiles.value.unshift(reactiveItem.value);
                        const currentItem = uploadingFiles.value[0];

                        try {
                            // 1. 初始化上传
                            const initRes = await fetch('/api/upload/init', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    filename: file.name,
                                    size: file.size,
                                    chunkSize: CHUNK_SIZE,
                                    lastModified: String(file.lastModified)
                                })
                            });
                            const { uploadId } = await initRes.json();

                            // 2. 切片并行上传
                            const chunksCount = Math.ceil(file.size / CHUNK_SIZE);
                            const chunks = Array.from({ length: chunksCount }, (_, i) => i);
                            let completedChunks = 0;

                            const uploadChunk = async (index) => {
                                const start = index * CHUNK_SIZE;
                                const end = Math.min(file.size, start + CHUNK_SIZE);
                                const chunk = file.slice(start, end);

                                const formData = new FormData();
                                formData.append('uploadId', uploadId);
                                formData.append('index', String(index));
                                formData.append('chunk', chunk);

                                let retry = 3;
                                while (retry > 0) {
                                    try {
                                        const res = await fetch('/api/upload/chunk', {
                                            method: 'POST',
                                            body: formData
                                        });
                                        if (res.ok) {
                                            completedChunks++;
                                            currentItem.progress = Math.round((completedChunks / chunksCount) * 100);
                                            return;
                                        }
                                    } catch (e) {
                                        console.error(`Chunk ${index} failed, retrying...`, e);
                                    }
                                    retry--;
                                    if (retry === 0) throw new Error(`Chunk ${index} failed after 3 retries`);
                                }
                            };

                            // 控制并发
                            for (let i = 0; i < chunks.length; i += CONCURRENT_LIMIT) {
                                const batch = chunks.slice(i, i + CONCURRENT_LIMIT);
                                await Promise.all(batch.map(index => uploadChunk(index)));
                            }

                            // 3. 完成合并
                            const completeRes = await fetch('/api/upload/complete', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    uploadId,
                                    filename: file.name,
                                    lastModified: String(file.lastModified)
                                })
                            });
                            
                            if (completeRes.ok) {
                                const result = await completeRes.json();
                                currentItem.status = result.status; // success, duplicate, need_confirm
                                currentItem.progress = 100;
                            } else {
                                currentItem.status = 'error';
                            }
                        } catch (e) {
                            console.error('Upload failed', e);
                            currentItem.status = 'error';
                        }
                    }
                    
                    await fetchPhotosIndex();
                    await fetchPending();
                    
                    if (pendingFiles.value.length > 0) {
                        activeTab.value = 'pending';
                    }
                    
                    setTimeout(() => {
                        showUpload.value = false;
                        uploadingFiles.value = [];
                    }, 5000); // 留长一点时间看状态
                };

                const handleFileSelect = (e) => handleFiles(e.target.files);
                const onDragOver = () => isDragging.value = true;
                const onDragLeave = () => isDragging.value = false;
                const onDrop = (e) => {
                    isDragging.value = false;
                    handleFiles(e.dataTransfer.files);
                };

                window.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    dragCounter++;
                    if (uploadingFiles.value.length === 0) {
                        isGlobalDragging.value = true;
                    }
                });

                window.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dragCounter--;
                    if (dragCounter <= 0) {
                        isGlobalDragging.value = false;
                        dragCounter = 0;
                    }
                });

                window.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });

                window.addEventListener('drop', (e) => {
                    e.preventDefault();
                    isGlobalDragging.value = false;
                    dragCounter = 0;
                    if (e.dataTransfer.files.length > 0) {
                        handleFiles(e.dataTransfer.files);
                    }
                });

                const scrollToGroup = (id) => {
                    ensureGroupVisibleAndScroll(id);
                };

                const toggleExpand = async (group) => {
                    if (!group.expanded) {
                        await ensureGroupPhotosLoaded(group);
                    }
                    group.expanded = !group.expanded;
                    setTimeout(() => lucide.createIcons(), 50);
                };

                const openLightbox = (photo) => {
                    lightbox.value = { show: true, photo };
                    setTimeout(() => lucide.createIcons(), 100);
                };

                const closeLightbox = () => lightbox.value.show = false;

                onMounted(() => {
                    loadBirthDate();
                    fetchPhotosIndex();
                    lucide.createIcons();
                    // 添加滚动监听
                    window.addEventListener('scroll', handleScroll);
                });

                // 组件卸载时移除滚动监听
                onUnmounted(() => {
                    window.removeEventListener('scroll', handleScroll);
                });

                return {
                    groups, activeTab, pendingFiles, loading, showUpload, isDragging, isGlobalDragging, uploadingFiles, lightbox,
                    showBirthDateModal, birthDateInput, birthDate, todayDate,
                    visibleCount, isLoadingMore, visibleGroups, loadMore,
                    formatDisplayDate, getBabyAge, saveBirthDate, loadBirthDate,
                    handleFileSelect, onDragOver, onDragLeave, onDrop,
                    openLightbox, closeLightbox, scrollToGroup, toggleExpand,
                    fetchPending, confirmFile, cancelFile, fetchPhotosIndex
                };
            }
        }).mount('#app');
    </script>

    <style>
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease, transform 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; transform: translateY(-20px); }
        
        .zoom-enter-active, .zoom-leave-active { transition: all 0.3s ease; }
        .zoom-enter-from, .zoom-leave-to { opacity: 0; transform: scale(0.9); }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 10px; }
    </style>
</body>
</html>
